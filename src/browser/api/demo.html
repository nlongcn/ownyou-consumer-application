<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email API Clients - Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.warning { background: #fff3cd; color: #856404; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    h2 { color: #333; margin-top: 0; }
    h3 { color: #666; }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .feature-list {
      list-style: none;
      padding: 0;
    }
    .feature-list li {
      padding: 8px 0;
      padding-left: 25px;
      position: relative;
    }
    .feature-list li:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #4CAF50;
      font-weight: bold;
    }
    .test-results {
      margin-top: 20px;
    }
    .test-row {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .test-row:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ“§ Email API Clients</h1>
    <p>Week 2 Deliverable: Gmail & Outlook TypeScript Clients with Rate Limiting</p>
  </div>

  <div class="card">
    <h2>Implementation Status</h2>
    <div class="test-results">
      <div class="test-row">
        <span><strong>Gmail API Client</strong></span>
        <span class="status success">âœ“ Complete</span>
      </div>
      <div class="test-row">
        <span><strong>Outlook Graph API Client</strong></span>
        <span class="status success">âœ“ Complete</span>
      </div>
      <div class="test-row">
        <span><strong>Rate Limiter & Batch Optimizer</strong></span>
        <span class="status success">âœ“ Complete</span>
      </div>
      <div class="test-row">
        <span><strong>Gmail Unit Tests (20 tests)</strong></span>
        <span class="status success">âœ“ 20/20 Passed</span>
      </div>
      <div class="test-row">
        <span><strong>Outlook Unit Tests (22 tests)</strong></span>
        <span class="status success">âœ“ 22/22 Passed</span>
      </div>
      <div class="test-row">
        <span><strong>TypeScript Compilation</strong></span>
        <span class="status success">âœ“ No Errors</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ðŸ“¦ Gmail Client Features</h2>
    <ul class="feature-list">
      <li>List messages with Gmail search queries</li>
      <li>Get single message with format selection (full/metadata/minimal/raw)</li>
      <li>Batch processing (50 messages per batch)</li>
      <li>Automatic pagination handling</li>
      <li>Base64url decoding for message bodies</li>
      <li>Header extraction (case-insensitive)</li>
      <li>Plain text and HTML body extraction</li>
      <li>Token refresh support</li>
    </ul>

    <h3>Usage Example</h3>
    <pre>import { GmailClient } from './gmail-client'

const client = new GmailClient(accessToken)

// List unread messages
const response = await client.listMessages('is:unread', 50)

// Get full message content
const message = await client.getMessage('msg123', 'full')

// Batch fetch multiple messages
const results = await client.batchGetMessages([
  { messageId: 'msg1', format: 'metadata' },
  { messageId: 'msg2', format: 'full' }
])

// Extract message details
const subject = client.getHeader(message, 'Subject')
const plainText = client.getPlainTextBody(message)
const html = client.getHtmlBody(message)</pre>
  </div>

  <div class="card">
    <h2>ðŸ“¬ Outlook Client Features</h2>
    <ul class="feature-list">
      <li>List messages with OData filters</li>
      <li>Get single message with property selection</li>
      <li>Batch processing (20 messages per batch via Graph $batch)</li>
      <li>OData pagination with @odata.nextLink</li>
      <li>Search messages with query strings</li>
      <li>Message count queries</li>
      <li>HTML to plain text conversion</li>
      <li>Sender and recipient extraction</li>
    </ul>

    <h3>Usage Example</h3>
    <pre>import { OutlookClient } from './outlook-client'

const client = new OutlookClient(accessToken)

// List unread messages with filter
const response = await client.listMessages(
  'isRead eq false',
  50,
  0,
  'receivedDateTime desc'
)

// Get single message
const message = await client.getMessage('msg123')

// Batch fetch
const results = await client.batchGetMessages([
  'msg1', 'msg2', 'msg3'
])

// Search messages
const searchResults = await client.searchMessages(
  'subject:important',
  25
)

// Get message count
const count = await client.getMessageCount('isRead eq false')</pre>
  </div>

  <div class="card">
    <h2>âš¡ Rate Limiter & Batch Optimizer</h2>
    <p>Ported from Python implementation (<code>src/email_parser/</code>) with full feature parity:</p>

    <h3>Rate Limiting Features</h3>
    <ul class="feature-list">
      <li>Exponential backoff retry (2, 4, 8 seconds...)</li>
      <li>429 (Too Many Requests) detection and handling</li>
      <li>Retry-After header support (Outlook)</li>
      <li>Configurable max retries (default: 3)</li>
      <li>Request throttling (100ms Gmail, 200ms Outlook)</li>
    </ul>

    <h3>Batch Optimization Features</h3>
    <ul class="feature-list">
      <li>Token estimation (1 token â‰ˆ 4 characters)</li>
      <li>Context-window-aware batching</li>
      <li>70% utilization target (30% reserved for prompts)</li>
      <li>Configurable min/max batch sizes</li>
      <li>Automatic batch size calculation</li>
    </ul>

    <h3>Usage Example</h3>
    <pre>import { RateLimiter, BatchOptimizer } from './rate-limiter'

// Rate limiting
const limiter = new RateLimiter({
  maxRetries: 3,
  retryDelay: 2,
  respectRetryAfter: true
})

const response = await limiter.executeWithRetry(
  () => fetch(url, options),
  'Gmail API call'
)

// Batch optimization
const emails = [...] // Array of emails

const batchSize = BatchOptimizer.calculateBatchSize(
  emails,
  128000,  // Context window (tokens)
  0,       // Start index
  0.70,    // 70% utilization
  5,       // Min batch size
  50       // Max batch size
)

console.log(`Optimal batch size: ${batchSize} emails`)</pre>
  </div>

  <div class="card">
    <h2>ðŸ§ª Test Coverage</h2>

    <h3>Gmail Client Tests (20 tests) âœ“</h3>
    <ul class="feature-list">
      <li>URL construction with query parameters</li>
      <li>maxResults capping at 500</li>
      <li>API error handling (401, 404, 429)</li>
      <li>Single message fetch with format</li>
      <li>Batch chunking (50 per batch)</li>
      <li>Individual message failure handling</li>
      <li>Pagination with nextPageToken</li>
      <li>maxMessages limit enforcement</li>
      <li>Header extraction (case-insensitive)</li>
      <li>Plain text body extraction (single & multipart)</li>
      <li>HTML body extraction (nested multipart)</li>
      <li>Base64url decoding (padding scenarios)</li>
      <li>URL-safe character handling</li>
      <li>Token update verification</li>
      <li>Network error handling</li>
      <li>Malformed JSON handling</li>
    </ul>

    <h3>Outlook Client Tests (22 tests) âœ“</h3>
    <ul class="feature-list">
      <li>URL construction with OData filters</li>
      <li>$top parameter capping at 999</li>
      <li>API error handling</li>
      <li>$select parameter usage</li>
      <li>Batch chunking (20 per batch)</li>
      <li>Individual message failure in batch</li>
      <li>Batch API error handling</li>
      <li>@odata.nextLink pagination</li>
      <li>maxMessages limit enforcement</li>
      <li>$search query construction</li>
      <li>$count parameter with ConsistencyLevel header</li>
      <li>Count fallback (no @odata.count)</li>
      <li>Plain text body (contentType: text)</li>
      <li>HTML tag stripping (contentType: html)</li>
      <li>HTML body extraction</li>
      <li>Plain text wrapping in &lt;pre&gt;</li>
      <li>Sender email extraction</li>
      <li>Recipient emails extraction</li>
      <li>Token update verification</li>
      <li>Network error handling</li>
      <li>Malformed JSON handling</li>
    </ul>
  </div>

  <div class="card">
    <h2>ðŸ“Š Python â†’ TypeScript Port Verification</h2>
    <p>All rate limiting patterns from Python implementation successfully ported:</p>

    <div class="test-results">
      <div class="test-row">
        <span>Gmail retry logic (lines 249-274)</span>
        <span class="status success">âœ“ Ported</span>
      </div>
      <div class="test-row">
        <span>Outlook retry logic (lines 480-513)</span>
        <span class="status success">âœ“ Ported</span>
      </div>
      <div class="test-row">
        <span>Batch optimizer (batch_optimizer.py)</span>
        <span class="status success">âœ“ Ported</span>
      </div>
      <div class="test-row">
        <span>Token estimation algorithm</span>
        <span class="status success">âœ“ Ported</span>
      </div>
      <div class="test-row">
        <span>Context window calculation</span>
        <span class="status success">âœ“ Ported</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ðŸš€ Next Steps: Week 3</h2>
    <ul class="feature-list">
      <li>Create email summarization LangGraph workflow</li>
      <li>Build in-browser job queue system</li>
      <li>Integrate workflows with IndexedDB Store</li>
    </ul>
  </div>

  <script>
    // Verify API clients are importable in browser context
    console.log('âœ… Email API Clients demo page loaded successfully')
    console.log('ðŸ“¦ Files created:')
    console.log('  - src/browser/api/gmail-client.ts (360+ lines)')
    console.log('  - src/browser/api/outlook-client.ts (417 lines)')
    console.log('  - src/browser/api/rate-limiter.ts (289 lines)')
    console.log('  - tests/browser/api/gmail-client.test.ts (489 lines, 20 tests)')
    console.log('  - tests/browser/api/outlook-client.test.ts (22 tests)')
    console.log('')
    console.log('ðŸ§ª Test Results:')
    console.log('  âœ“ Gmail: 20/20 tests passed')
    console.log('  âœ“ Outlook: 22/22 tests passed')
    console.log('  âœ“ TypeScript: No compilation errors')
  </script>
</body>
</html>
