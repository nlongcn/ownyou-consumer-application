#!/usr/bin/env node
/**
 * Generates build-info.json with version and timestamp
 * Run before each build to track deployments
 */

import { readFileSync, writeFileSync } from 'fs';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = join(__dirname, '..');

// Read current version from package.json
const packageJson = JSON.parse(readFileSync(join(rootDir, 'package.json'), 'utf8'));
const tauriConfigPath = join(rootDir, 'src-tauri', 'tauri.conf.json');

// Get git info if available
let gitCommit = 'unknown';
let gitBranch = 'unknown';
try {
  gitCommit = execSync('git rev-parse --short HEAD', { encoding: 'utf8' }).trim();
  gitBranch = execSync('git branch --show-current', { encoding: 'utf8' }).trim();
} catch (e) {
  // Git not available
}

// Generate build timestamp
const now = new Date();
const buildTimestamp = now.toISOString();
const buildDate = now.toLocaleDateString('en-GB', {
  day: '2-digit',
  month: 'short',
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
  timeZoneName: 'short'
});

// Auto-increment patch version
const versionParts = packageJson.version.split('.');
const major = parseInt(versionParts[0]);
const minor = parseInt(versionParts[1]);
const patch = parseInt(versionParts[2]) + 1;
const newVersion = `${major}.${minor}.${patch}`;

// Update package.json version
packageJson.version = newVersion;
writeFileSync(join(rootDir, 'package.json'), JSON.stringify(packageJson, null, 2) + '\n');

// Update tauri.conf.json version
try {
  const tauriConfig = JSON.parse(readFileSync(tauriConfigPath, 'utf8'));
  tauriConfig.version = newVersion;
  writeFileSync(tauriConfigPath, JSON.stringify(tauriConfig, null, 2) + '\n');
} catch (e) {
  // Tauri config might not exist for PWA-only builds
}

// Create build info
const buildInfo = {
  version: newVersion,
  buildTimestamp,
  buildDate,
  gitCommit,
  gitBranch,
  buildNumber: Date.now()
};

// Write to public folder for runtime access
writeFileSync(
  join(rootDir, 'public', 'build-info.json'),
  JSON.stringify(buildInfo, null, 2)
);

// Write TypeScript module for compile-time access
const tsContent = `// Auto-generated by generate-build-info.js - DO NOT EDIT
export const BUILD_INFO = {
  version: '${newVersion}',
  buildTimestamp: '${buildTimestamp}',
  buildDate: '${buildDate}',
  gitCommit: '${gitCommit}',
  gitBranch: '${gitBranch}',
  buildNumber: ${Date.now()}
} as const;
`;

writeFileSync(join(rootDir, 'src', 'build-info.ts'), tsContent);

console.log(`âœ… Build info generated: v${newVersion} (${buildDate})`);
console.log(`   Git: ${gitBranch}@${gitCommit}`);
