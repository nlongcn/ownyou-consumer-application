## BBS+ Pseudonym Implementation Specification

### 1. BBS+ Pseudonym Overview

BBS+ Pseudonyms are a cryptographic mechanism that enables privacy-preserving attribution while allowing users to maintain control over how their data is used. The implementation follows the IETF draft specification [BBS+ Pseudonyms](https://github.com/cfrg/draft-irtf-cfrg-bbs-pseudonyms) and provides:

* **Context-specific identifiers**: Pseudonyms tied to specific campaign contexts that cannot be linked across different contexts
* **User control**: The user explicitly authorizes each context where their pseudonym is used
* **Cryptographic verification**: Zero-knowledge proofs that validate pseudonym ownership without revealing the user's identity
* **Signer-prover separation**: The identity provider cannot track the user's activities through pseudonym usage

### 2. Core Cryptographic Components

#### 2.1 Key Components

* **`prover_nym`**: A random scalar value generated by the user (via their wallet) that forms the user's part of their pseudonym secret.
* **`signer_nym_entropy`**: A random value contributed by the identity provider that is combined with the user's `prover_nym`.
* **`nym_secret`**: The core cryptographic secret held by the user, calculated as `prover_nym + signer_nym_entropy`.
* **`context_id`**: A public identifier defining the specific context where a pseudonym is valid (typically a `campaign_ID` in advertising use cases).
* **BBS+ Pseudonym**: A point on elliptic curve G1, calculated as `hash_to_curve_g1(context_id) * nym_secret`.

#### 2.2 Essential Operations

* **Pseudonym Generation**: The mathematical process of creating a context-specific pseudonym from a `nym_secret` and a `context_id`.
* **Zero-Knowledge Proof Generation**: Creates a proof that demonstrates the pseudonym was correctly derived without revealing the `nym_secret`.
* **Verification**: Confirms the validity of pseudonyms and their associated proofs.

### 3. Implementation Flow

#### 3.1 Initial Setup Flow

1.**Identity Creation**:
* User wallet generates `prover_nym` (random scalar)
* User creates blind commitment to `prover_nym`
* Identity provider adds `signer_nym_entropy` and signs
* User wallet calculates final `nym_secret` = `prover_nym + signer_nym_entropy`
2.**Identity Verification**:
* User wallet verifies the BBS signature using the `VerifyFinalizeWithNym` operation
* The wallet securely stores the `nym_secret` for future pseudonym generation

#### 3.2 Attribution Flow

1.**Pseudonym Generation**:
* User receives tracking request with `campaign_ID` (as `context_id`)
* User wallet displays consent request with campaign details
* Upon consent, wallet calculates `pseudonym = hash_to_curve_g1(campaign_ID) * nym_secret`
* Wallet generates Zero-Knowledge Proof that:
* The pseudonym was correctly derived from the campaign ID
* The `nym_secret` was properly signed by trusted issuer
* The user knows the `nym_secret`
2.**Verification Process**:
* Verifier receives pseudonym and proof
* Verifier confirms the proof validates against the provided pseudonym and context
* Verifier can recognize the same pseudonym in future interactions within the same context

### 4. Performance Optimization Strategies

#### 4.1 Multi-Path Verification

To accommodate different performance requirements, the implementation supports two verification paths:

* **Fast-Path Verification**:
* Uses campaign ID indexing for immediate recognition
* Performs partial verification focused on pseudonym recognition
* Optimization: Pre-compute and cache cryptographic values
* Typical performance: 5-15ms on server hardware
* Appropriate for: Header bidding, retargeting, time-sensitive ad serving
* **Complete Verification**:
* Performs full cryptographic verification of the pseudonym and ZKP
* Validates both correct derivation and legitimate ownership
* Typical performance: 20-50ms on server hardware
* Appropriate for: Payment authorization, settlement, secure attribution

#### 4.2 Optimization Techniques

1.**Witness Caching**:
* Cache verification witnesses for returning users
* Significantly improves verification speed (5-10x speedup)
* Implementation requirement: Secure, isolated storage of verification artifacts
2.**Campaign Context Indexing**:
* Store pseudonyms indexed by campaign ID for fast lookup
* Defer complete verification to an asynchronous process
* Implementation consideration: Maintain strict context isolation
3.**Batched Verification**:
* Group multiple verifications together for efficiency
* Particularly effective for processing conversions
* Implementation requirement: Carefully manage batch timeout parameters

#### 4.3 Performance Benchmarks

| Operation| Mobile Device | Browser | Server|
| :--------------------- | :------------ | :-------- | :------ |
| Pseudonym Generation | 50-200ms| 30-100ms| 5-15ms|
| Fast-Path Verification | 80-250ms| 20-100ms| 5-15ms|
| Complete Verification| 150-500ms | 50-200ms| 20-50ms |

### 5. Security Considerations

#### 5.1 Risk Factors

* **Side-Channel Attacks**: Implementation should resist timing and other side-channel attacks
* **Witness Isolation**: Verification witnesses must be isolated between different contexts
* **Randomness Quality**: Secure random number generation is critical for `prover_nym`
* **Key Management**: The `nym_secret` requires secure storage equivalent to private keys

#### 5.2 Security-Performance Trade-offs

The implementation must explicitly define acceptable trade-offs for different verification contexts:

* **High Security (Payment, Settlement)**:
* Complete cryptographic verification required
* No shortcuts or optimizations that impact security
* Performance secondary to correctness
* **Balanced (Initial Ad Display)**:
* Complete verification with reasonable timeout
* Graceful degradation if verification exceeds timeout
* Secondary confirmation can proceed asynchronously
* **Performance Critical (Retargeting)**:
* Fast-path verification with indexed campaign lookup
* Cached witnesses for returning users
* Balance immediate response with basic security checks

### 6. Development Resources

* **IETF Specification**: Current draft available at [github.com/cfrg/draft-irtf-cfrg-bbs-pseudonyms](https://github.com/cfrg/draft-irtf-cfrg-bbs-pseudonyms)
* **Reference Libraries**:
* Hyperledger Ursa (Rust)
* MATTR BBS Signatures (TypeScript)
* OwnYou Reference Implementation (coming soon)
* **Test Framework**: Comprehensive test suite with vectors for all operations
* **Performance Tools**: Benchmarking suite for optimization validation

